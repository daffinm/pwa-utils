<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>sw test</title>
    <meta id="meta-viewport" name="viewport"
          content="user-scalable=yes, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">

    <script src="js/assert.js"></script>
    <script src="js/debug-console.js"></script>
    <script src="js/sw-utils.js"></script>
    <script src="js/sw-client.js"></script>

    <link rel="manifest" href="manifest.json">
    <style>
        #status-messages {
            --status-color: black;
            font-weight: bold;
            color: white;
            background-color: var(--status-color);
            padding: 10px;
            border: solid 1px var(--status-color);
            width: fit-content;
            border-radius: 10px;
        }
        #status-messages.controller-present {
            --status-color: #57c100;
        }
        #status-messages.controller-absent {
            --status-color: indianred;
        }
        #time-stamp {
            font-weight: bold;
            color: white;
            background-color: cornflowerblue;
            padding: 10px;
            border: solid 1px cornflowerblue;
            width: fit-content;
            border-radius: 10px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<h1>Service Worker Test</h1>
<div id="status-messages"></div>
<ol>
    <li>Open the dev tools console asap and check the console messages to see what's happening.</li>
    <li>Simulate an upate by adding/removing spaces from the end of the <i>sw.js</i> file.</li>
    <li>Press the 'Check for updates' button</li>
    <li>
        Play with accepting and rejecting updates at different times. (Note what happens if you reject an update
        when the page is not controlled by a service worker.)
    </li>
</ol>
<p>
    Note that changing any file other than the sw.js file <a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle#updates">does NOT count as an update</a>.
</p>
<button id="check-for-updates">Check for updates...</button>
<div id="time-stamp"></div>

<script type="module">

    const debug = new DebugConsole(true, 'Application', 'cornflowerblue');
    debug.heading('Application Starting up...');
    // Status messages - so we can see what's going on.
    let $messages = document.getElementById('status-messages');
    let underControl = navigator.serviceWorker.controller;
    let className = (underControl ? 'controller-present' : 'controller-absent');
    let message = (underControl ? 'This page IS controlled by a Service Worker' : 'This page is NOT controlled by a Service Worker');
    $messages.className = className;
    $messages.innerHTML = message;
    // The callback object - implements an interface (I wish) that enables us to decouple the service worker client from
    // the app that's using it.
    const app = {
        noUpdateFound() {
            alert(`No update found\n\nYou are already on the latest version.`);
        },
        updateError(err) {
            alert(`Error\n\nCannot check for updates.\n\nAre you offline?`);
        },
        updateFoundReloadNeeded() {
            // Called when an update is found but the client is not controlled by the service worker. This means that
            // the update will activate automatically. So the client will need to play catch up with the service worker:
            // to reload so that it becomes controlled by it.
            // Inform the user with OK dialog and reload when this returns (to give some sense of control).
            alert('Update found!\n\nApp will reload when you press OK.');
            app.reload();
        },
        confirmUpdateWithUser(callback) {
            if (confirm(`Update available!\n\nAn update is available for this app.\n\nUse it now?`)) {
                callback(true);
            }
            else {
                callback(false);
            }
        },
        reload() {
            debug.warn('Reloading app...');
            document.body.style = 'color:red;';
            setTimeout(() => window.location.reload(), 1000);
        }
    };
    const swc = new ServiceWorkerClient('sw.js', debug, app);
    swc.register();
    // The update button
    const updateButton = document.getElementById('check-for-updates');
    updateButton.addEventListener('click', function () {
        swc.update(true);
    });
    // The load-time date stamp
    const dateStamp = document.getElementById('time-stamp');
    const loadDate = new Date();
    dateStamp.innerHTML = `Last reload: ${loadDate.toDateString()} @ ${loadDate.toLocaleTimeString()}` ;

</script>
</body>
</html>